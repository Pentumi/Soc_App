generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Club {
  id            Int          @id @default(autoincrement())
  name          String
  inviteCode    String       @unique @default(uuid()) @map("invite_code")
  ownerId       Int          @map("owner_id")
  defaultFormat String       @default("Stroke Play") @map("default_format")
  allowSelfJoin Boolean      @default(false) @map("allow_self_join")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  owner         User         @relation("ClubOwner", fields: [ownerId], references: [id])
  members       ClubMember[]
  tournaments   Tournament[]

  @@map("clubs")
}

model ClubMember {
  id       Int      @id @default(autoincrement())
  clubId   Int      @map("club_id")
  userId   Int      @map("user_id")
  role     String   // 'owner', 'admin', 'player', 'spectator'
  joinedAt DateTime @default(now()) @map("joined_at")
  club     Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clubId, userId])
  @@index([userId])
  @@index([clubId])
  @@map("club_members")
}

model User {
  id                      Int                      @id @default(autoincrement())
  email                   String                   @unique
  passwordHash            String                   @map("password_hash")
  firstName               String                   @map("first_name")
  lastName                String                   @map("last_name")
  profilePhoto            String?                  @map("profile_photo")
  currentHandicap         Decimal?                 @map("current_handicap") @db.Decimal(4, 1)
  createdAt               DateTime                 @default(now()) @map("created_at")
  updatedAt               DateTime                 @updatedAt @map("updated_at")
  ownedClubs              Club[]                   @relation("ClubOwner")
  clubMemberships         ClubMember[]
  tournamentParticipation TournamentParticipant[]
  tournamentScores        TournamentScore[]
  handicapHistory         HandicapHistory[]
  friendsReceived         Friend[]                 @relation("FriendUser")
  friendsInitiated        Friend[]                 @relation("UserFriends")

  @@map("users")
}

model Course {
  id           Int          @id @default(autoincrement())
  name         String
  location     String?
  par          Int
  slopeRating  Decimal?     @map("slope_rating") @db.Decimal(5, 1)
  courseRating Decimal?     @map("course_rating") @db.Decimal(5, 1)
  createdAt    DateTime     @default(now()) @map("created_at")
  holes        Hole[]
  tournaments  Tournament[]

  @@map("courses")
}

model Hole {
  id          Int         @id @default(autoincrement())
  courseId    Int         @map("course_id")
  holeNumber  Int         @map("hole_number")
  par         Int
  strokeIndex Int?        @map("stroke_index")
  yardage     Int?
  holeScores  HoleScore[]
  course      Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, holeNumber])
  @@map("holes")
}

model Tournament {
  id                 Int                      @id @default(autoincrement())
  clubId             Int                      @map("club_id")
  name               String
  inviteCode         String                   @unique @default(uuid()) @map("invite_code")
  courseId           Int                      @map("course_id")
  tournamentDate     DateTime                 @map("tournament_date") @db.Date
  startTime          String?                  @map("start_time")
  format             String                   @default("Stroke Play")
  isMajor            Boolean                  @default(true) @map("is_major")
  status             String                   @default("upcoming")
  allowSelfJoin      Boolean                  @default(false) @map("allow_self_join")
  playerCap          Int?                     @map("player_cap")
  leaderboardVisible Boolean                  @default(true) @map("leaderboard_visible")
  createdAt          DateTime                 @default(now()) @map("created_at")
  club               Club                     @relation(fields: [clubId], references: [id])
  course             Course                   @relation(fields: [courseId], references: [id])
  participants       TournamentParticipant[]
  tournamentScores   TournamentScore[]

  @@map("tournaments")
}

model TournamentParticipant {
  id           Int              @id @default(autoincrement())
  tournamentId Int              @map("tournament_id")
  userId       Int              @map("user_id")
  role         String           // 'admin', 'player', 'spectator'
  team         String?
  flight       String?
  status       String           @default("registered") // 'registered', 'waitlist', 'withdrawn'
  joinedAt     DateTime         @default(now()) @map("joined_at")
  tournament   Tournament       @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  scores       TournamentScore[]

  @@unique([tournamentId, userId])
  @@index([userId])
  @@index([tournamentId])
  @@index([flight])
  @@map("tournament_participants")
}

model TournamentScore {
  id                 Int                   @id @default(autoincrement())
  tournamentId       Int                   @map("tournament_id")
  participantId      Int                   @map("participant_id")
  userId             Int                   @map("user_id") // Keep for backward compatibility
  grossScore         Int                   @map("gross_score")
  handicapAtTime     Decimal               @map("handicap_at_time") @db.Decimal(4, 1)
  netScore           Int                   @map("net_score")
  position           Int?
  handicapAdjustment Int                   @default(0) @map("handicap_adjustment")
  stablefordPoints   Int?                  @map("stableford_points")
  createdAt          DateTime              @default(now()) @map("created_at")
  tournament         Tournament            @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  participant        TournamentParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  user               User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  holeScores         HoleScore[]

  @@unique([tournamentId, userId])
  @@map("tournament_scores")
}

model HoleScore {
  id                Int             @id @default(autoincrement())
  tournamentScoreId Int             @map("tournament_score_id")
  holeId            Int             @map("hole_id")
  strokes           Int
  putts             Int?
  fairwayHit        Boolean?        @map("fairway_hit")
  greenInRegulation Boolean?        @map("green_in_regulation")
  stablefordPoints  Int?            @map("stableford_points")
  hole              Hole            @relation(fields: [holeId], references: [id], onDelete: Cascade)
  tournamentScore   TournamentScore @relation(fields: [tournamentScoreId], references: [id], onDelete: Cascade)

  @@unique([tournamentScoreId, holeId])
  @@map("hole_scores")
}

model HandicapHistory {
  id            Int      @id @default(autoincrement())
  userId        Int      @map("user_id")
  handicapIndex Decimal  @map("handicap_index") @db.Decimal(4, 1)
  tournamentId  Int?     @map("tournament_id")
  reason        String?
  effectiveDate DateTime @map("effective_date") @db.Date
  createdAt     DateTime @default(now()) @map("created_at")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("handicap_history")
}

model Friend {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  friendId  Int      @map("friend_id")
  status    String   @default("pending")
  createdAt DateTime @default(now()) @map("created_at")
  friend    User     @relation("FriendUser", fields: [friendId], references: [id], onDelete: Cascade)
  user      User     @relation("UserFriends", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
  @@map("friends")
}
